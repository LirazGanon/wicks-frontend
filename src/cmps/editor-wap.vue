<template>

<section class="wap-wapper">

  <div class="phone-display-header" v-if="responsiveClass.length" :style="{ maxWidth: conMaxWidth }">
    
  </div>

  <section class="page-editor" ref="container" :class="[responsiveClass, wrapper()]" :style="{ maxWidth: conMaxWidth }">

    <section v-if="!cmpsLength" class="wap-placeholder">

    </section>



    <Container group-name="column" :get-child-payload="itemIndex => getChildPayload(itemIndex)"
      :should-accept-drop="() => true" :should-animate-drop="() => true" @drop="onDrop($event)">
      <Draggable v-if="wapToEdit" v-for="cmp in wapToEdit.cmps" :key="cmp.id">
        <component :is="cmp.type" :cmp="cmp" @openEditor="$emit('openEditor', $event)" />

      </Draggable>

    </Container>


  </section>

  <div class="phone-display-footer" v-if="responsiveClass.length" :style="{ maxWidth: conMaxWidth }">
  </div>
</section>

</template>
  
<script>
import { Container, Draggable } from "vue3-smooth-dnd";

import wapHeader from '../cmps/waps-edit/wap-header-edit.vue'
import wapHero from '../cmps/waps-edit/wap-hero-edit.vue'
import wapForm from '../cmps/waps-edit/wap-form-edit.vue'
import wapContainer from '../cmps/waps-edit/wap-container-edit.vue'

import wapContact from '../cmps/waps-edit/wap-contact-edit.vue'
import wapReviews from '../cmps/waps-edit/wap-reviews-edit.vue'

import wapFooter from '../cmps/waps-edit/wap-footer-edit.vue'
import wapBgImg from '../cmps/waps-edit/wap-bg-img-edit.vue'
import appHeader from "./app-header.vue";


import { wapService } from '../services/wap.service.local.js'
import { utilService } from "../services/util.service";
import { eventBus } from "../services/event-bus.service";
import { useStore } from "vuex";
export default {
  name: "wap",
  components: { Draggable, Container, wapHeader, wapHero, wapForm, wapContainer, wapContact, wapReviews, wapFooter, appHeader, wapBgImg },
  props: { wap: Object },
  data() {
    return {
      responsiveClass: [],
      conMaxWidth: null,
      class: []
    }
  },
  async created() {
    const id = this.$route.params.wapId
    try {
      this.$store.dispatch({ type: 'setWapToEdit', id })
    } catch {
      console.log('cannot load wap');
    }
  },
  mounted() {
    eventBus.on('resizeWap', this.resize)
    // new ResizeObserver(this.resized).observe(this.$refs.container)
  },
  unmounted() {
    this.$store.commit({ type: 'removeWapToEdit' })
  },
  methods: {

    getChildPayload(itemIndex) {
      const wap = this.$store.getters.getWapToEdit
      return wap.cmps[itemIndex]
    },
    onDrop(dropResult) {
      let wap = this.$store.getters.getWapToEdit
      wap = utilService.copy(wap)

      let result = this.applyDrag(wap.cmps, dropResult)
      wap.cmps = result


      try {
        this.$store.dispatch({ type: 'updateWapFull', wap })
      } catch {
        console.log('ops');
      }
    },
    applyDrag(arr, dragResult) {
      const { removedIndex, addedIndex, payload } = dragResult;
      if (removedIndex === null && addedIndex === null) return arr;
      const result = [...arr];
      let itemToAdd = { ...payload };
      if (removedIndex !== null) {

        itemToAdd = result.splice(removedIndex, 1)[0];
      }
      if (addedIndex !== null) {
        result.splice(addedIndex, 0, itemToAdd);
      }
      return result;

    },
    resized() {
      if (!this.$refs.container) return
      const { offsetWidth } = this.$refs.container
      if (offsetWidth < 620) this.responsiveClass = 'mobile'
      if (offsetWidth >= 620) this.responsiveClass = this.small()
      if (offsetWidth >= 860) this.responsiveClass = this.medium()
      if (offsetWidth >= 1024) this.responsiveClass = this.narrow()
      if (offsetWidth >= 1300) this.responsiveClass = this.normal()
      if (offsetWidth >= 1500) this.responsiveClass = this.wide()

    },
    resize(size) {
      const puk = size == '100' ? size + '%' : size + 'px'
      this.conMaxWidth = puk
      if (+size < 500) this.responsiveClass = 'mobile'
      if (+size >= 600) this.responsiveClass = 'tablet'
      if (size === '100') this.responsiveClass = ''
    },

    wrapper() {
      if (this.conMaxWidth === 420) return 'smartphone'
      if (this.conMaxWidth === 800) return 'tablet'
      return ''
    },
    small() {
      return ['small']
    },
    medium() {
      return [...this.small(), 'medium']
    },
    narrow() {
      return [...this.medium(), 'narrow']
    },
    normal() {
      return [...this.narrow(), 'normal']
    },
    wide() {
      return [...this.normal(), 'wide']
    }
  },
  computed: {
    wapToEdit() {
      return this.$store.getters.getWapToEdit
    },
    cmpsLength() {
      const wap = this.wapToEdit
      return wap?.cmps.length || 0
    }

  }
};
</script>